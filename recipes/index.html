<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipes | rcpbx</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' font-family='monospace' fill='%2316a34a'>%3E</text></svg>">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2VNWY2BFX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-E2VNWY2BFX');
  </script>
  <meta name="description" content="">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .loading{text-align:center;padding:4rem 1rem;color:var(--text-muted)}
    .loading::after{content:'';display:block;width:24px;height:24px;margin:1rem auto;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{text-align:center;padding:4rem 1rem;color:#c00}
    
    /* Category listing */
    .category-header{padding:2rem 1.5rem 1rem;max-width:var(--max-width);margin:0 auto}
    .category-header h1{font-size:1.75rem;font-weight:700;margin-bottom:0.25rem}
    .category-header p{color:var(--text-muted);font-size:0.9rem}
    .recipe-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;padding:0 1.5rem 2rem;max-width:var(--max-width);margin:0 auto}
    .recipe-link{display:block;padding:1.25rem;background:var(--card);border:1px solid var(--border);border-radius:6px;text-decoration:none;transition:all 0.15s}
    .recipe-link:hover{border-color:var(--accent);transform:translateY(-2px)}
    .recipe-link h2{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:0.25rem}
    .recipe-link p{font-size:0.85rem;color:var(--text-muted);line-height:1.4}
    .recipe-link .meta{font-family:var(--font-mono);font-size:0.7rem;color:var(--text-dim);margin-top:0.5rem}
    
    /* Chef quote */
    .chef-quote{padding:1rem 1.5rem;border-top:1px solid var(--border);font-style:italic;font-size:0.85rem;color:var(--text-dim);text-align:center}
    .chef-quote .chef-name{font-style:normal;color:var(--text-muted)}
    
    /* Wake lock */
    .wake-lock{position:fixed;bottom:1rem;left:1rem;font-family:var(--font-mono);font-size:0.7rem;color:var(--text-dim);background:var(--bg);border:1px solid var(--border);padding:0.4rem 0.75rem;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:0.4rem;z-index:100}
    .wake-lock:hover{border-color:var(--accent);color:var(--text-muted)}
    .wake-lock input{accent-color:var(--accent)}
    .print-date{display:none}
    .print-qr{display:none}
    
    /* Unit toggle */
    .amount[data-metric]{cursor:pointer;border-bottom:1px dashed var(--accent);transition:all 0.15s}
    .amount[data-metric]:hover{color:var(--accent)}
    
    /* Timers */
    .step-timer{display:inline-block;background:var(--accent-dim);color:var(--accent);padding:0.15rem 0.4rem;border-radius:3px;font-family:var(--font-mono);font-size:0.8rem;cursor:pointer;margin-left:0.25rem;transition:all 0.15s}
    .step-timer:hover{background:var(--accent);color:white}
    .timer-popup{position:fixed;bottom:5rem;right:1rem;background:var(--card);border:2px solid var(--accent);border-radius:8px;padding:1rem 1.25rem;font-family:var(--font-mono);z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.15);min-width:160px;text-align:center}
    .timer-popup.hidden{display:none}
    .timer-display{font-size:2rem;font-weight:700;color:var(--text);margin:0.5rem 0}
    .timer-label{font-size:0.75rem;color:var(--text-muted);margin-bottom:0.5rem}
    .timer-btn{background:var(--bg);border:1px solid var(--border);color:var(--text-muted);padding:0.3rem 0.6rem;border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;cursor:pointer;margin:0.25rem}
    .timer-btn:hover{border-color:var(--accent);color:var(--accent)}
    .timer-btn.stop{border-color:#e55;color:#e55}
    
    /* Print */
    @media print {
      .chef-quote{display:block !important;position:absolute;bottom:0.1in;right:0.15in;left:auto;padding:0 !important;border:none !important;font-size:5pt !important;text-align:right !important;max-width:1.8in}
      .print-qr{display:flex !important;position:fixed;top:0.08in;right:0.08in;flex-direction:column;align-items:center;gap:0.02in}
      .print-qr img{width:0.45in !important;height:0.45in !important}
      .print-qr span{font-family:var(--font-mono);font-size:4pt;color:#999}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="../" class="logo-container" tabindex="0">
        <span class="logo-text"><span class="logo-prefix">&gt;</span><span class="logo-char">r</span><span class="logo-vowel v-e1">e</span><span class="logo-char">c</span><span class="logo-vowel v-i">i</span><span class="logo-char">p</span><span class="logo-vowel v-e2">e</span><span class="logo-char">b</span><span class="logo-vowel v-o">o</span><span class="logo-char">x</span></span>
      </a>
      <a href="../reference/" class="header-link">kitchen ref →</a>
    </div>
  </header>
  <main>
    <div id="content"><div class="loading">Loading...</div></div>
  </main>
  <footer class="site-footer"><p class="footer-line"><span style="color:var(--accent);font-weight:500">rcpbx.com</span><span class="sep">·</span><span>$0 VC</span><span class="sep">·</span><span class="never-acquired">never acquired</span></p></footer>
  <button class="print-btn" onclick="window.print()" style="display:none" id="print-btn">Print Card</button>
  <label class="wake-lock" id="wake-lock" style="display:none"><input type="checkbox" id="wake-lock-toggle"> Keep screen on</label>
  <script>
const chefQuotes = [
  {q: "People who love to eat are always the best people.", c: "Julia Child"},
  {q: "A recipe has no soul. You, as the cook, must bring soul to the recipe.", c: "Thomas Keller"},
  {q: "Good food is very often, even most often, simple food.", c: "Anthony Bourdain"},
  {q: "Fat gives things flavor.", c: "Julia Child"},
  {q: "One cannot think well, love well, sleep well, if one has not dined well.", c: "Virginia Woolf"},
  {q: "Tell me what you eat, and I will tell you who you are.", c: "Brillat-Savarin"},
  {q: "First we eat, then we do everything else.", c: "M.F.K. Fisher"},
  {q: "If you are afraid of butter, use cream.", c: "Julia Child"},
  {q: "Cooking is one failure after another, and that's how you finally learn.", c: "Julia Child"},
  {q: "No one is born a great cook, one learns by doing.", c: "Julia Child"},
  {q: "Once you understand the foundations of cooking, you become free.", c: "Thomas Keller"},
  {q: "Store-bought is fine.", c: "Ina Garten"},
  {q: "Don't be a recipe slave.", c: "Alton Brown"},
  {q: "Season as you go.", c: "Jacques Pépin"},
  {q: "Great cooking favors the prepared hands.", c: "Jacques Pépin"},
  {q: "Fat is flavor.", c: "Samin Nosrat"},
  {q: "Never trust a skinny cook.", c: "Italian Proverb"},
  {q: "Mise en place.", c: "Every Chef Ever"}
];
const randomQuote = chefQuotes[Math.floor(Math.random() * chefQuotes.length)];

const params = new URLSearchParams(window.location.search);
const recipeId = params.get('r') || window.location.hash.slice(1) || null;
const categorySlug = params.get('cat') || null;

const categoryNames = {
  'soups-stews': 'Soups & Stews',
  'pasta': 'Pasta',
  'chicken': 'Chicken',
  'beef': 'Beef',
  'pork': 'Pork',
  'seafood': 'Seafood',
  'breakfast': 'Breakfast',
  'sides': 'Sides',
  'baking-dessert': 'Baking & Desserts',
  'basics': 'Basics'
};

if (recipeId) {
  loadRecipe(recipeId);
} else if (categorySlug) {
  loadCategory(categorySlug);
} else {
  document.getElementById('content').innerHTML = '<div class="error">No recipe or category specified. <a href="../">Go home</a></div>';
}

async function loadCategory(slug) {
  const categoryName = categoryNames[slug] || slug;
  document.title = `${categoryName} | rcpbx`;
  
  try {
    // Fetch the recipe index
    const response = await fetch('../data/index.json');
    let recipes;
    
    if (response.ok) {
      const index = await response.json();
      recipes = index.filter(r => r.categorySlug === slug);
    } else {
      // Fallback: load all JSON files (slower)
      recipes = await loadAllRecipes(slug);
    }
    
    if (recipes.length === 0) {
      document.getElementById('content').innerHTML = `<div class="error">No recipes found in ${categoryName}. <a href="../">Go home</a></div>`;
      return;
    }
    
    renderCategoryList(categoryName, recipes);
  } catch (err) {
    console.error(err);
    document.getElementById('content').innerHTML = `<div class="error">Error loading recipes. <a href="../">Go home</a></div>`;
  }
}

async function loadAllRecipes(filterSlug) {
  // Known recipe IDs - we'll try to fetch each one
  const recipeIds = [
    'apple-pie','baby-back-ribs','baked-beans','baked-chicken-breast','baked-cod','baked-potato','baked-ziti',
    'banana-bread','bbq-sauce','bechamel','beef-and-broccoli','beef-barley-soup','beef-fajitas','beef-stew',
    'beef-stroganoff','beef-tacos','biscuits','biscuits-and-gravy','blueberry-muffins','bolognese','breakfast-burrito',
    'breakfast-casserole','broccoli-cheddar-soup','brownies','buffalo-wings','cacio-e-pepe','carbonara','carnitas',
    'carrot-cake','cheesecake','chicken-alfredo','chicken-fried-rice','chicken-marsala','chicken-noodle-soup',
    'chicken-parmesan','chicken-pot-pie','chicken-salad','chicken-stir-fry','chicken-stock','chicken-tacos',
    'chicken-tikka-masala','chicken-tortilla-soup','chili-by-george','chocolate-cake','chocolate-chip-cookies',
    'cinnamon-rolls','coleslaw','cornbread','crab-cakes','dinner-rolls','eggs-benedict','fish-and-chips','fish-tacos',
    'french-onion-soup','french-toast','fried-chicken','glazed-ham','gravy','green-bean-casserole','guacamole',
    'hash-browns','homemade-bread','lasagna','mac-and-cheese','macaroni-salad','marinara-sauce','mashed-potatoes',
    'meatloaf','minestrone','omelette','pan-seared-salmon','pan-seared-steak','pancakes','pasta-primavera',
    'peach-cobbler','philly-cheesesteak','pie-crust','pizza-dough','pork-chops','pork-fried-rice','pork-tenderloin',
    'pot-roast','potato-salad','potato-soup','pound-cake','pulled-pork','pumpkin-pie','quiche','rice-pilaf',
    'roast-chicken','roasted-vegetables','salmon-patties','salsa','scrambled-eggs','shepherds-pie','shrimp-boil',
    'shrimp-scampi','sloppy-joes','smash-burgers','spaghetti-and-meatballs','split-pea-soup','stuffed-shells',
    'stuffing','sugar-cookies','swedish-meatballs','tomato-soup','tuna-noodle-casserole','tuna-salad','vinaigrette',
    'waffles','white-chicken-chili'
  ];
  
  const recipes = [];
  for (const id of recipeIds) {
    try {
      const res = await fetch(`../data/${id}.json`);
      if (res.ok) {
        const recipe = await res.json();
        if (recipe.categorySlug === filterSlug) {
          recipes.push(recipe);
        }
      }
    } catch (e) {}
  }
  return recipes;
}

function renderCategoryList(categoryName, recipes) {
  let html = `
    <div class="category-header">
      <p style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text-dim);margin-bottom:0.5rem"><a href="../" style="color:var(--text-muted);text-decoration:none">Home</a> → ${categoryName}</p>
      <h1>${categoryName}</h1>
      <p>${recipes.length} recipes</p>
    </div>
    <div class="recipe-grid">
  `;
  
  recipes.sort((a, b) => a.title.localeCompare(b.title));
  
  for (const r of recipes) {
    const time = r.time || (r.prep && r.cook ? `${r.prep} + ${r.cook}` : r.prep || r.cook || '');
    html += `
      <a href="?r=${r.id}" class="recipe-link">
        <h2>${r.title}</h2>
        <p>${r.tagline || r.description || ''}</p>
        <div class="meta">${time}${r.serves ? ` · serves ${r.serves}` : ''}${r.makes ? ` · makes ${r.makes}` : ''}</div>
      </a>
    `;
  }
  
  html += '</div>';
  document.getElementById('content').innerHTML = html;
}

// Unit conversions
const conversions = {
  'cup': {metric: 'ml', factor: 237, round: 0},
  'cups': {metric: 'ml', factor: 237, round: 0},
  'tbsp': {metric: 'ml', factor: 15, round: 0},
  'tablespoon': {metric: 'ml', factor: 15, round: 0},
  'tablespoons': {metric: 'ml', factor: 15, round: 0},
  'tsp': {metric: 'ml', factor: 5, round: 1},
  'teaspoon': {metric: 'ml', factor: 5, round: 1},
  'teaspoons': {metric: 'ml', factor: 5, round: 1},
  'oz': {metric: 'g', factor: 28, round: 0},
  'ounce': {metric: 'g', factor: 28, round: 0},
  'ounces': {metric: 'g', factor: 28, round: 0},
  'lb': {metric: 'g', factor: 454, round: 0},
  'lbs': {metric: 'g', factor: 454, round: 0},
  'pound': {metric: 'g', factor: 454, round: 0},
  'pounds': {metric: 'g', factor: 454, round: 0},
  'fl oz': {metric: 'ml', factor: 30, round: 0},
  'quart': {metric: 'L', factor: 0.95, round: 2},
  'quarts': {metric: 'L', factor: 0.95, round: 2},
  'pint': {metric: 'ml', factor: 473, round: 0},
  'pints': {metric: 'ml', factor: 473, round: 0},
  'gallon': {metric: 'L', factor: 3.8, round: 1},
  'gallons': {metric: 'L', factor: 3.8, round: 1}
};

function parseAmount(amount) {
  const regex = /^([\d\/\.\s½¼¾⅓⅔⅛]+)\s*(cup|cups|tbsp|tablespoons?|tsp|teaspoons?|oz|ounces?|lbs?|pounds?|fl oz|quarts?|pints?|gallons?)\b/i;
  const match = amount.match(regex);
  if (match) {
    const num = parseFraction(match[1]);
    const unit = match[2].toLowerCase();
    const conv = conversions[unit];
    if (conv && num) {
      const metric = (num * conv.factor).toFixed(conv.round).replace(/\.0+$/, '');
      return `<span class="amount" data-imperial="${amount}" data-metric="${metric}${conv.metric}" data-showing="imperial">${amount}</span>`;
    }
  }
  return `<span class="amount">${amount}</span>`;
}

function parseIngredient(str) {
  const regex = /^([\d\/\.\s½¼¾⅓⅔⅛]+)\s*(cup|cups|tbsp|tablespoons?|tsp|teaspoons?|oz|ounces?|lbs?|pounds?|fl oz|quarts?|pints?|gallons?)\b/i;
  const match = str.match(regex);
  if (match) {
    const parsed = parseAmount(match[0]);
    return parsed + str.slice(match[0].length);
  }
  return str;
}

function parseFraction(str) {
  const fractions = {'½': 0.5, '¼': 0.25, '¾': 0.75, '⅓': 0.333, '⅔': 0.667, '⅛': 0.125};
  let total = 0;
  const parts = str.trim().split(/\s+/);
  for (const p of parts) {
    if (fractions[p]) total += fractions[p];
    else if (p.includes('/')) {
      const [n, d] = p.split('/');
      total += parseFloat(n) / parseFloat(d);
    } else {
      total += parseFloat(p) || 0;
    }
  }
  return total;
}

function parseTimers(text) {
  const regex = /(\d+)[\s-]*(minutes?|mins?|hours?|hrs?|seconds?|secs?)/gi;
  return text.replace(regex, (match, num, unit) => {
    const u = unit.toLowerCase();
    let seconds = parseInt(num);
    if (u.startsWith('h')) seconds *= 3600;
    else if (u.startsWith('m')) seconds *= 60;
    return `${match}<button class="step-timer" data-seconds="${seconds}" onclick="startTimer(${seconds}, '${match}')">⏱</button>`;
  });
}

async function loadRecipe(id) {
  try {
    const response = await fetch(`../data/${id}.json`);
    if (!response.ok) throw new Error('Recipe not found');
    const recipe = await response.json();
    renderRecipe(recipe);
  } catch (err) {
    document.getElementById('content').innerHTML = `<div class="error">Recipe not found: ${id}. <a href="../">Go home</a></div>`;
  }
}

function renderRecipe(r) {
  document.title = `${r.title} | rcpbx`;
  document.querySelector('meta[name="description"]').content = r.description || r.tagline;
  
  let metaHtml = '';
  if (r.prep) metaHtml += `<div class="meta-item"><span class="meta-label">Prep</span><span class="meta-value">${r.prep}</span></div>`;
  if (r.cook) metaHtml += `<div class="meta-item"><span class="meta-label">Cook</span><span class="meta-value">${r.cook}</span></div>`;
  if (r.time && !r.prep && !r.cook) metaHtml += `<div class="meta-item"><span class="meta-label">Time</span><span class="meta-value">${r.time}</span></div>`;
  if (r.serves) metaHtml += `<div class="meta-item"><span class="meta-label">Serves</span><span class="meta-value">${r.serves}</span></div>`;
  if (r.makes) metaHtml += `<div class="meta-item"><span class="meta-label">Makes</span><span class="meta-value">${r.makes}</span></div>`;
  
  const ingredientsHtml = r.ingredients.map(i => {
    if (typeof i === 'string') return `<li>${parseIngredient(i)}</li>`;
    if (i.amount) return `<li>${parseAmount(i.amount)} ${i.item}</li>`;
    return `<li>${i.item || i}</li>`;
  }).join('');
  
  const stepsHtml = r.steps.map(s => `<li>${parseTimers(s)}</li>`).join('');
  const notesHtml = r.notes ? r.notes.map(n => `<p>${n}</p>`).join('') : '';
  
  let sourceHtml = '';
  if (r.source) {
    sourceHtml = `<span>${r.source}</span>`;
    if (r.sourceUrl) sourceHtml += ` <a href="${r.sourceUrl}" target="_blank" rel="noopener">View original →</a>`;
  }
  
  const catLink = r.categorySlug ? `<a href="?cat=${r.categorySlug}" style="color:var(--text-muted);text-decoration:none">${r.category}</a>` : r.category;
  
  document.getElementById('content').innerHTML = `
    <div class="container" style="padding-top:1.5rem">
      <p class="breadcrumb"><a href="../">Home</a> → ${catLink} → ${r.title}</p>
    </div>
    <article class="recipe-card">
      <header class="recipe-header"><h1 class="recipe-title">${r.title}</h1><p class="recipe-tagline">${r.tagline}</p></header>
      <div class="recipe-meta">${metaHtml}</div>
      <div class="recipe-body">
        <section class="ingredients"><h2 class="section-title">Ingredients</h2><ul class="ingredients-list">${ingredientsHtml}</ul></section>
        <section class="steps"><h2 class="section-title">Steps</h2><ol class="steps-list">${stepsHtml}</ol></section>
      </div>
      ${notesHtml ? `<div class="recipe-notes"><h2 class="section-title">Notes</h2>${notesHtml}</div>` : ''}
      ${sourceHtml ? `<footer class="recipe-footer">${sourceHtml}</footer>` : ''}
      <div class="chef-quote">"${randomQuote.q}" <span class="chef-name">—${randomQuote.c}</span></div>
      <div class="print-date">printed ${new Date().toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</div>
      <div class="print-qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=${encodeURIComponent(window.location.href)}" alt="QR"><span>rcpbx.com</span></div>
    </article>
  `;
  
  document.getElementById('print-btn').style.display = 'block';
  document.getElementById('wake-lock').style.display = 'flex';
  document.querySelectorAll('.ingredients-list li').forEach(li => {
    li.addEventListener('click', () => li.classList.toggle('checked'));
  });
  document.querySelectorAll('.steps-list li').forEach(li => {
    li.addEventListener('click', () => li.classList.toggle('done'));
  });
}

// Wake lock
let wakeLock = null;
const wakeLockToggle = document.getElementById('wake-lock-toggle');
wakeLockToggle?.addEventListener('change', async () => {
  if (wakeLockToggle.checked) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => {
        wakeLockToggle.checked = false;
      });
    } catch (e) {
      wakeLockToggle.checked = false;
    }
  } else if (wakeLock) {
    wakeLock.release();
    wakeLock = null;
  }
});

// Unit toggle
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('amount') && e.target.dataset.metric) {
    const showing = e.target.dataset.showing;
    if (showing === 'imperial') {
      e.target.textContent = e.target.dataset.metric;
      e.target.dataset.showing = 'metric';
    } else {
      e.target.textContent = e.target.dataset.imperial;
      e.target.dataset.showing = 'imperial';
    }
  }
});

// Timer
let timerInterval = null;
let timerRemaining = 0;

function startTimer(seconds, label) {
  if (timerInterval) clearInterval(timerInterval);
  timerRemaining = seconds;
  
  const popup = document.getElementById('timer-popup');
  const display = document.getElementById('timer-display');
  const timerLabel = document.getElementById('timer-label');
  
  timerLabel.textContent = label;
  popup.classList.remove('hidden');
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    timerRemaining--;
    updateTimerDisplay();
    if (timerRemaining <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      timerDone();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const display = document.getElementById('timer-display');
  const mins = Math.floor(timerRemaining / 60);
  const secs = timerRemaining % 60;
  display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function timerDone() {
  const display = document.getElementById('timer-display');
  display.textContent = "Done!";
  if ('vibrate' in navigator) navigator.vibrate([200, 100, 200, 100, 200]);
  try { new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(300).join('9')).play(); } catch(e) {}
}

function pauseTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  } else if (timerRemaining > 0) {
    timerInterval = setInterval(() => {
      timerRemaining--;
      updateTimerDisplay();
      if (timerRemaining <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        timerDone();
      }
    }, 1000);
  }
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  timerRemaining = 0;
  document.getElementById('timer-popup').classList.add('hidden');
}
  </script>
  <div id="timer-popup" class="timer-popup hidden">
    <div id="timer-label" class="timer-label"></div>
    <div id="timer-display" class="timer-display">0:00</div>
    <button class="timer-btn" onclick="pauseTimer()">Pause</button>
    <button class="timer-btn stop" onclick="stopTimer()">Stop</button>
  </div>
</body>
</html>
