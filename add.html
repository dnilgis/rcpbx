<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add a Recipe | rcpbx</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 2rem;
      line-height: 1.6;
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    
    .back-link {
      color: #888;
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 1rem;
    }
    .back-link:hover { color: #fff; }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    h1 span { color: #4a9eff; }
    
    .subtitle {
      color: #888;
      margin-bottom: 2rem;
    }
    
    /* Auth Section */
    .auth-section {
      background: #252525;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .auth-section h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    
    .auth-section p {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    
    .google-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      background: #fff;
      color: #333;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .google-btn:hover { background: #f0f0f0; }
    
    .google-btn svg {
      width: 20px;
      height: 20px;
    }
    
    /* User info when logged in */
    .user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .user-info span { color: #4a9eff; }
    
    .sign-out-btn {
      background: transparent;
      border: 1px solid #444;
      color: #888;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .sign-out-btn:hover {
      border-color: #666;
      color: #fff;
    }
    
    /* Tabs */
    .tabs {
      display: none;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #333;
    }
    .tabs.visible { display: flex; }
    
    .tab {
      background: none;
      border: none;
      color: #888;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab:hover { color: #fff; }
    .tab.active {
      color: #4a9eff;
      border-bottom-color: #4a9eff;
    }
    
    /* Form sections */
    .form-section {
      display: none;
    }
    .form-section.visible { display: block; }
    
    /* URL Import */
    .url-input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .url-input-group input {
      flex: 1;
      background: #252525;
      border: 1px solid #333;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 1rem;
    }
    .url-input-group input:focus {
      outline: none;
      border-color: #4a9eff;
    }
    
    .fetch-btn {
      background: #4a9eff;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      white-space: nowrap;
    }
    .fetch-btn:hover { background: #3a8eef; }
    .fetch-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    
    /* Status messages */
    .status {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }
    .status.visible { display: block; }
    .status.loading {
      background: #2a2a3a;
      color: #8888ff;
    }
    .status.error {
      background: #3a2a2a;
      color: #ff8888;
    }
    .status.success {
      background: #2a3a2a;
      color: #88ff88;
    }
    
    /* Recipe Form */
    .recipe-form {
      display: none;
    }
    .recipe-form.visible { display: block; }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group label {
      display: block;
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      background: #252525;
      border: 1px solid #333;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #4a9eff;
    }
    
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 500px) {
      .form-row, .form-row-3 {
        grid-template-columns: 1fr;
      }
    }
    
    .helper-text {
      color: #666;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    
    /* Submit button */
    .submit-btn {
      background: #22c55e;
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 1rem;
    }
    .submit-btn:hover { background: #1ea550; }
    .submit-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    
    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: #666;
      margin: 1.5rem 0;
    }
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê back to rcpbx</a>
    
    <h1><span>&gt;_</span> Add a Recipe</h1>
    <p class="subtitle">Paste a URL and let AI do the work, or enter manually.</p>
    
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
      <div id="signedOut">
        <h2>Sign in to submit recipes</h2>
        <p>We just need to know who's cooking.</p>
        <button class="google-btn" id="googleSignIn">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign in with Google
        </button>
      </div>
      <div id="signedIn" style="display: none;">
        <div class="user-info">
          <span id="userEmail"></span>
          <button class="sign-out-btn" id="signOutBtn">Sign out</button>
        </div>
      </div>
    </div>
    
    <!-- Tabs (hidden until signed in) -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="url">Import from URL</button>
      <button class="tab" data-tab="manual">Enter manually</button>
    </div>
    
    <!-- URL Import Section -->
    <div class="form-section" id="urlSection">
      <div class="url-input-group">
        <input type="url" id="urlInput" placeholder="https://example.com/recipe...">
        <button class="fetch-btn" id="fetchBtn">Fetch</button>
      </div>
      <div class="status" id="status"></div>
    </div>
    
    <!-- Manual Entry Section -->
    <div class="form-section" id="manualSection">
      <p style="color: #888; margin-bottom: 1rem;">Fill in the recipe details below.</p>
    </div>
    
    <!-- Recipe Form (shown after fetch or for manual entry) -->
    <form class="recipe-form" id="recipeForm">
      <div class="form-group">
        <label>Title *</label>
        <input type="text" id="title" required placeholder="e.g., Classic Banana Bread">
      </div>
      
      <div class="form-group">
        <label>Tagline</label>
        <input type="text" id="tagline" placeholder="e.g., Moist, sweet, and foolproof">
      </div>
      
      <div class="form-group">
        <label>Category *</label>
        <select id="category" required>
          <option value="">Select a category...</option>
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="sides">Sides</option>
          <option value="soups">Soups</option>
          <option value="salads">Salads</option>
          <option value="desserts">Desserts</option>
          <option value="breads">Breads</option>
          <option value="drinks">Drinks</option>
          <option value="basics">Basics</option>
        </select>
      </div>
      
      <div class="form-row-3">
        <div class="form-group">
          <label>Prep Time</label>
          <input type="text" id="prepTime" placeholder="e.g., 15 min">
        </div>
        <div class="form-group">
          <label>Cook Time</label>
          <input type="text" id="cookTime" placeholder="e.g., 1 hr">
        </div>
        <div class="form-group">
          <label>Serves / Makes</label>
          <input type="text" id="serves" placeholder="e.g., 4 or 1 loaf">
        </div>
      </div>
      
      <div class="form-group">
        <label>Ingredients *</label>
        <textarea id="ingredients" required placeholder="One ingredient per line, e.g.:
2 cups flour
1 tsp salt
3 ripe bananas"></textarea>
        <p class="helper-text">One ingredient per line. Include measurements.</p>
      </div>
      
      <div class="form-group">
        <label>Steps *</label>
        <textarea id="steps" required placeholder="One step per line, e.g.:
Preheat oven to 350¬∞F
Mix dry ingredients in a bowl
Mash bananas and add to mixture"></textarea>
        <p class="helper-text">One step per line. Keep it simple.</p>
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea id="notes" style="min-height: 80px;" placeholder="Optional tips, variations, storage instructions..."></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Source</label>
          <input type="text" id="source" placeholder="e.g., Grandma, NYT Cooking">
        </div>
        <div class="form-group">
          <label>Source URL</label>
          <input type="url" id="sourceUrl" placeholder="https://...">
        </div>
      </div>
      
      <button type="submit" class="submit-btn" id="submitBtn">Submit Recipe for Review</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configuration
    const SUPABASE_URL = 'https://edwidciitqarkukjaary.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkd2lkY2lpdHFhcmt1a2phYXJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTg4NDMsImV4cCI6MjA4NTQ3NDg0M30.NAFNjdOvJFrm44LapANWZCyIRDuPUbrxLR5GcX2aYUc';
    const ANTHROPIC_API_KEY = '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';
    
    // Initialize Supabase
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // State
    let currentUser = null;
    
    // DOM Elements
    const signedOutEl = document.getElementById('signedOut');
    const signedInEl = document.getElementById('signedIn');
    const userEmailEl = document.getElementById('userEmail');
    const tabsEl = document.getElementById('tabs');
    const urlSectionEl = document.getElementById('urlSection');
    const manualSectionEl = document.getElementById('manualSection');
    const recipeFormEl = document.getElementById('recipeForm');
    const statusEl = document.getElementById('status');
    
    // Auth Functions
    async function signInWithGoogle() {
      const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + window.location.pathname
        }
      });
      if (error) {
        console.error('Login error:', error);
        alert('Login failed: ' + error.message);
      }
    }
    
    async function signOut() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      updateUI();
    }
    
    async function checkSession() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
      }
      updateUI();
    }
    
    // Listen for auth changes
    supabaseClient.auth.onAuthStateChange((event, session) => {
      currentUser = session?.user || null;
      updateUI();
    });
    
    function updateUI() {
      if (currentUser) {
        signedOutEl.style.display = 'none';
        signedInEl.style.display = 'block';
        userEmailEl.textContent = currentUser.email;
        tabsEl.classList.add('visible');
        urlSectionEl.classList.add('visible');
      } else {
        signedOutEl.style.display = 'block';
        signedInEl.style.display = 'none';
        tabsEl.classList.remove('visible');
        urlSectionEl.classList.remove('visible');
        manualSectionEl.classList.remove('visible');
        recipeFormEl.classList.remove('visible');
      }
    }
    
    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabName = tab.dataset.tab;
        if (tabName === 'url') {
          urlSectionEl.classList.add('visible');
          manualSectionEl.classList.remove('visible');
          recipeFormEl.classList.remove('visible');
        } else {
          urlSectionEl.classList.remove('visible');
          manualSectionEl.classList.add('visible');
          recipeFormEl.classList.add('visible');
          clearForm();
        }
      });
    });
    
    // URL Fetching with AI
    document.getElementById('fetchBtn').addEventListener('click', async () => {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        showStatus('Please enter a URL', 'error');
        return;
      }
      
      showStatus('Fetching recipe page...', 'loading');
      document.getElementById('fetchBtn').disabled = true;
      
      try {
        // Fetch the page content via CORS proxy
        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        const response = await fetch(proxyUrl);
        
        if (!response.ok) {
          throw new Error('Failed to fetch page');
        }
        
        const html = await response.text();
        showStatus('Parsing recipe with AI...', 'loading');
        
        // Use Claude to parse the recipe
        const parsed = await parseRecipeWithAI(html, url);
        
        if (parsed) {
          populateForm(parsed);
          document.getElementById('sourceUrl').value = url;
          recipeFormEl.classList.add('visible');
          showStatus('Recipe parsed! Review and edit below.', 'success');
        } else {
          showStatus('Could not parse recipe. Try entering manually.', 'error');
        }
      } catch (error) {
        console.error('Fetch error:', error);
        showStatus('Error fetching page: ' + error.message, 'error');
      }
      
      document.getElementById('fetchBtn').disabled = false;
    });
    
    async function parseRecipeWithAI(html, url) {
      // Clean up HTML - remove scripts, styles, keep text
      const textContent = html
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
        .replace(/<[^>]+>/g, '\n')
        .replace(/\s+/g, ' ')
        .trim()
        .substring(0, 15000); // Limit for API
      
      const prompt = `Extract the recipe from this webpage content. Return ONLY valid JSON with these fields:
{
  "title": "Recipe title",
  "tagline": "Short description (optional)",
  "category": "one of: breakfast, lunch, dinner, sides, soups, salads, desserts, breads, drinks, basics",
  "prepTime": "e.g., 15 min",
  "cookTime": "e.g., 1 hr",
  "serves": "e.g., 4 servings or 1 loaf",
  "ingredients": ["ingredient 1", "ingredient 2"],
  "steps": ["step 1", "step 2"],
  "notes": "optional tips",
  "source": "source name if found"
}

Webpage content:
${textContent}`;

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [{
              role: 'user',
              content: prompt
            }]
          })
        });
        
        if (!response.ok) {
          const errText = await response.text();
          console.error('API error:', errText);
          throw new Error('AI parsing failed');
        }
        
        const data = await response.json();
        const content = data.content[0].text;
        
        // Extract JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
      } catch (error) {
        console.error('AI parsing error:', error);
      }
      
      return null;
    }
    
    function populateForm(data) {
      document.getElementById('title').value = data.title || '';
      document.getElementById('tagline').value = data.tagline || '';
      document.getElementById('category').value = data.category || '';
      document.getElementById('prepTime').value = data.prepTime || '';
      document.getElementById('cookTime').value = data.cookTime || '';
      document.getElementById('serves').value = data.serves || '';
      document.getElementById('ingredients').value = Array.isArray(data.ingredients) 
        ? data.ingredients.join('\n') 
        : data.ingredients || '';
      document.getElementById('steps').value = Array.isArray(data.steps) 
        ? data.steps.join('\n') 
        : data.steps || '';
      document.getElementById('notes').value = data.notes || '';
      document.getElementById('source').value = data.source || '';
    }
    
    function clearForm() {
      document.getElementById('title').value = '';
      document.getElementById('tagline').value = '';
      document.getElementById('category').value = '';
      document.getElementById('prepTime').value = '';
      document.getElementById('cookTime').value = '';
      document.getElementById('serves').value = '';
      document.getElementById('ingredients').value = '';
      document.getElementById('steps').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('source').value = '';
      document.getElementById('sourceUrl').value = '';
    }
    
    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = 'status visible ' + type;
    }
    
    // Form Submission
    recipeFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Please sign in first');
        return;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      // Parse ingredients and steps into arrays
      const ingredientsText = document.getElementById('ingredients').value.trim();
      const stepsText = document.getElementById('steps').value.trim();
      
      const ingredients = ingredientsText.split('\n').filter(line => line.trim());
      const steps = stepsText.split('\n').filter(line => line.trim());
      
      // Determine serves vs makes
      const servesValue = document.getElementById('serves').value.trim();
      let serves = null;
      let makes = null;
      
      if (servesValue) {
        if (/loaf|batch|dozen|cup|pie|cake|cookies/i.test(servesValue)) {
          makes = servesValue;
        } else {
          serves = servesValue;
        }
      }
      
      const recipeData = {
        user_id: currentUser.id,
        user_email: currentUser.email,
        status: 'pending',
        title: document.getElementById('title').value.trim(),
        tagline: document.getElementById('tagline').value.trim() || null,
        category: document.getElementById('category').value,
        prep_time: document.getElementById('prepTime').value.trim() || null,
        cook_time: document.getElementById('cookTime').value.trim() || null,
        serves: serves,
        makes: makes,
        ingredients: ingredients,
        steps: steps,
        notes: document.getElementById('notes').value.trim() || null,
        source: document.getElementById('source').value.trim() || null,
        source_url: document.getElementById('sourceUrl').value.trim() || null
      };
      
      try {
        const { data, error } = await supabaseClient
          .from('recipes')
          .insert([recipeData])
          .select();
        
        if (error) {
          throw error;
        }
        
        // Success!
        alert('Recipe submitted! It will appear on the site after review.');
        clearForm();
        recipeFormEl.classList.remove('visible');
        document.getElementById('urlInput').value = '';
        statusEl.className = 'status';
        
      } catch (error) {
        console.error('Submit error:', error);
        alert('Error submitting recipe: ' + error.message);
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Recipe for Review';
    });
    
    // Event Listeners
    document.getElementById('googleSignIn').addEventListener('click', signInWithGoogle);
    document.getElementById('signOutBtn').addEventListener('click', signOut);
    
    // Initialize
    checkSession();
  </script>
</body>
</html>
