<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Recipe | rcpbx</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' font-family='monospace' fill='%2316a34a'>%3E</text></svg>">
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf9f6;
      --bg-alt: #f0efeb;
      --card: #fff;
      --text: #222;
      --text-muted: #666;
      --text-dim: #999;
      --border: #ddd;
      --accent: #16a34a;
      --accent-dim: rgba(22,163,74,0.1);
      --error: #dc2626;
      --error-dim: rgba(220,38,38,0.1);
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'Courier New', monospace;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111;
        --bg-alt: #1a1a1a;
        --card: #1a1a1a;
        --text: #e5e5e5;
        --text-muted: #999;
        --text-dim: #666;
        --border: #333;
        --accent: #22c55e;
        --accent-dim: rgba(34,197,94,0.15);
      }
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-family: var(--font-sans); background: var(--bg); color: var(--text); }
    body { min-height: 100vh; padding: 2rem 1rem; }
    
    .container { max-width: 800px; margin: 0 auto; }
    
    .header { margin-bottom: 2rem; }
    .header a { color: var(--text-muted); text-decoration: none; font-family: var(--font-mono); font-size: 0.8rem; }
    .header a:hover { color: var(--accent); }
    .header h1 { font-size: 1.5rem; margin-top: 0.5rem; }
    .header p { color: var(--text-muted); font-size: 0.9rem; }
    
    .login-section { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 3rem 2rem; 
      text-align: center;
      max-width: 400px;
      margin: 4rem auto;
    }
    .login-section h2 { font-size: 1.1rem; margin-bottom: 0.5rem; }
    .login-section p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    
    .google-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: var(--font-sans);
      font-size: 0.95rem;
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.15s;
    }
    .google-btn:hover { border-color: #bbb; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .google-btn svg { width: 20px; height: 20px; }
    
    .user-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
    }
    .user-info { display: flex; align-items: center; gap: 0.75rem; }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--accent);
      font-size: 0.8rem;
    }
    .user-avatar img { width: 100%; height: 100%; border-radius: 50%; }
    .user-email { color: var(--text-muted); }
    .logout-btn {
      background: none;
      border: 1px solid var(--border);
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
    }
    .logout-btn:hover { border-color: var(--error); color: var(--error); }
    
    .form-section { display: none; }
    .form-section.active { display: block; }
    
    .step { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 1.5rem; 
      margin-bottom: 1rem;
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .step-num {
      width: 28px;
      height: 28px;
      background: var(--accent-dim);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .step-title { font-weight: 600; }
    .step-badge {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    
    label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
    }
    
    input[type="text"], input[type="url"], textarea, select {
      width: 100%;
      padding: 0.75rem 1rem;
      font-family: var(--font-mono);
      font-size: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); }
    textarea { min-height: 120px; resize: vertical; font-family: var(--font-sans); }
    
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .input-row { grid-template-columns: 1fr; } }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-ai { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
    .btn-ai:hover { opacity: 0.9; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    
    .btn-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    
    .status {
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      display: none;
    }
    .status.show { display: block; }
    .status.loading { background: var(--accent-dim); color: var(--accent); }
    .status.loading.ai { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(99,102,241,0.15)); color: #7c3aed; }
    .status.success { background: var(--accent-dim); color: var(--accent); }
    .status.error { background: var(--error-dim); color: var(--error); }
    
    .help {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: -0.75rem;
      margin-bottom: 1rem;
    }
    
    .list-editor { margin-bottom: 1rem; }
    .list-item { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .list-item input { flex: 1; margin-bottom: 0; }
    .list-item button {
      width: 36px;
      height: 36px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .list-item button:hover { border-color: var(--error); color: var(--error); }
    .add-item-btn {
      background: var(--accent-dim);
      border: 1px dashed var(--accent);
      color: var(--accent);
      padding: 0.5rem 1rem;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    .add-item-btn:hover { background: var(--accent); color: white; }
    
    .success-message {
      text-align: center;
      padding: 3rem 2rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .success-message .icon { font-size: 4rem; margin-bottom: 1rem; }
    .success-message h2 { margin-bottom: 0.5rem; }
    .success-message p { color: var(--text-muted); margin-bottom: 1.5rem; }
    
    .my-recipes {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }
    .my-recipes h3 { font-size: 1rem; margin-bottom: 1rem; }
    .recipe-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .recipe-item:last-child { border-bottom: none; }
    .recipe-title { font-weight: 500; }
    .recipe-status {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    .recipe-status.pending { background: #fef3c7; color: #92400e; }
    .recipe-status.approved { background: var(--accent-dim); color: var(--accent); }
    .no-recipes { color: var(--text-dim); font-size: 0.9rem; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-pulse { animation: pulse 1.5s ease-in-out infinite; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="../">‚Üê back to rcpbx</a>
      <h1>>_ Add a Recipe</h1>
      <p>Paste a URL and let AI do the work, or enter manually.</p>
    </header>
    
    <div class="login-section" id="loginSection">
      <h2>Sign in to submit recipes</h2>
      <p>We just need to know who's cooking.</p>
      <button class="google-btn" onclick="signInWithGoogle()">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
    </div>
    
    <div class="form-section" id="formSection">
      <div class="user-bar">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <span class="user-email" id="userEmail">Loading...</span>
        </div>
        <button class="logout-btn" onclick="signOut()">Sign out</button>
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">1</span>
          <span class="step-title">Import from URL</span>
          <span class="step-badge">AI-Powered</span>
        </div>
        <label for="importUrl">Recipe URL</label>
        <input type="url" id="importUrl" placeholder="https://www.seriouseats.com/...">
        <p class="help">Paste any recipe URL. AI will extract and format everything.</p>
        <div class="btn-row">
          <button class="btn btn-ai" onclick="importRecipeWithAI()" id="importBtn">
            <span>‚ú® Import with AI</span>
          </button>
          <button class="btn btn-secondary" onclick="clearForm()">Clear & Start Fresh</button>
        </div>
        <div class="status" id="importStatus"></div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">2</span>
          <span class="step-title">Recipe Details</span>
        </div>
        
        <label for="title">Title *</label>
        <input type="text" id="title" placeholder="Chicken Parmesan">
        
        <label for="tagline">Tagline *</label>
        <input type="text" id="tagline" placeholder="Crispy cutlets, bubbling mozzarella">
        <p class="help">One punchy line that sells the dish</p>
        
        <label for="category">Category *</label>
        <select id="category">
          <option value="">Select category...</option>
          <option value="soups-stews">Soups & Stews</option>
          <option value="pasta">Pasta</option>
          <option value="chicken">Chicken</option>
          <option value="beef">Beef</option>
          <option value="pork">Pork</option>
          <option value="seafood">Seafood</option>
          <option value="breakfast">Breakfast</option>
          <option value="sides">Sides</option>
          <option value="baking-dessert">Baking & Desserts</option>
          <option value="basics">Basics</option>
        </select>
        
        <div class="input-row">
          <div>
            <label for="prepTime">Prep Time</label>
            <input type="text" id="prepTime" placeholder="20 min">
          </div>
          <div>
            <label for="cookTime">Cook Time</label>
            <input type="text" id="cookTime" placeholder="45 min">
          </div>
        </div>
        
        <div class="input-row">
          <div>
            <label for="serves">Serves</label>
            <input type="text" id="serves" placeholder="4-6">
          </div>
          <div>
            <label for="makes">Makes (if applicable)</label>
            <input type="text" id="makes" placeholder="24 cookies">
          </div>
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">3</span>
          <span class="step-title">Ingredients *</span>
        </div>
        <p class="help">One ingredient per line. Include amounts.</p>
        <div class="list-editor" id="ingredientsList"></div>
        <button class="add-item-btn" onclick="addIngredient()">+ Add Ingredient</button>
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">4</span>
          <span class="step-title">Steps *</span>
        </div>
        <p class="help">One step per line. Be concise but complete.</p>
        <div class="list-editor" id="stepsList"></div>
        <button class="add-item-btn" onclick="addStep()">+ Add Step</button>
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">5</span>
          <span class="step-title">Notes & Source</span>
        </div>
        
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Tips, substitutions, what makes this recipe work..."></textarea>
        <p class="help">Separate multiple notes with a blank line</p>
        
        <label for="source">Source</label>
        <input type="text" id="source" placeholder="Serious Eats / Kenji L√≥pez-Alt">
        
        <label for="sourceUrl">Source URL</label>
        <input type="url" id="sourceUrl" placeholder="https://...">
      </div>
      
      <div class="step">
        <div class="step-header">
          <span class="step-num">6</span>
          <span class="step-title">Submit</span>
        </div>
        
        <p class="help" style="margin-top: 0; margin-bottom: 1rem;">Your recipe will be reviewed before appearing on the site.</p>
        
        <button class="btn btn-primary" onclick="submitRecipe()" id="submitBtn">
          <span>Submit Recipe</span>
        </button>
        
        <div class="status" id="submitStatus"></div>
      </div>
      
      <div class="my-recipes" id="myRecipes">
        <h3>My Submissions</h3>
        <div id="recipesList">
          <p class="no-recipes">Loading...</p>
        </div>
      </div>
    </div>
    
    <div class="form-section" id="successSection">
      <div class="success-message">
        <div class="icon">üéâ</div>
        <h2>Recipe Submitted!</h2>
        <p>We'll review it and add it to the site soon.</p>
        <button class="btn btn-primary" onclick="resetAll()">Add Another Recipe</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    const SUPABASE_URL = 'https://edwidciitqarkukjaary.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkd2lkY2lpdHFhcmt1a2phYXJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTg4NDMsImV4cCI6MjA4NTQ3NDg0M30.NAFNjdOvJFrm44LapANWZCyIRDuPUbrxLR5GcX2aYUc';
    const ANTHROPIC_API_KEY = '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';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
    
    let currentUser = null;
    
    async function signInWithGoogle() {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.href }
      });
      if (error) {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
      }
    }
    
    async function signOut() {
      await supabase.auth.signOut();
      currentUser = null;
      showLogin();
    }
    
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        showForm();
        loadMyRecipes();
      } else {
        showLogin();
      }
    }
    
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        currentUser = session.user;
        showForm();
        loadMyRecipes();
      } else {
        showLogin();
      }
    });
    
    function showLogin() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('formSection').classList.remove('active');
      document.getElementById('successSection').classList.remove('active');
    }
    
    function showForm() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('formSection').classList.add('active');
      document.getElementById('successSection').classList.remove('active');
      
      const email = currentUser.email || 'Unknown';
      document.getElementById('userEmail').textContent = email;
      
      const avatarEl = document.getElementById('userAvatar');
      if (currentUser.user_metadata?.avatar_url) {
        avatarEl.innerHTML = '<img src="' + currentUser.user_metadata.avatar_url + '" alt="">';
      } else {
        avatarEl.textContent = email.charAt(0).toUpperCase();
      }
      
      initForm();
    }
    
    function showSuccess() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('formSection').classList.remove('active');
      document.getElementById('successSection').classList.add('active');
    }
    
    function initForm() {
      if (document.querySelectorAll('#ingredientsList .list-item').length === 0) {
        for (let i = 0; i < 5; i++) addIngredient();
      }
      if (document.querySelectorAll('#stepsList .list-item').length === 0) {
        for (let i = 0; i < 4; i++) addStep();
      }
    }
    
    function addIngredient(value) {
      value = value || '';
      const list = document.getElementById('ingredientsList');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = '<input type="text" value="' + escapeHtml(value) + '" placeholder="1 cup flour"><button onclick="this.parentElement.remove()" title="Remove">√ó</button>';
      list.appendChild(item);
    }
    
    function addStep(value) {
      value = value || '';
      const list = document.getElementById('stepsList');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = '<input type="text" value="' + escapeHtml(value) + '" placeholder="Preheat oven to 375¬∞F."><button onclick="this.parentElement.remove()" title="Remove">√ó</button>';
      list.appendChild(item);
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function clearForm() {
      document.getElementById('importUrl').value = '';
      document.getElementById('title').value = '';
      document.getElementById('tagline').value = '';
      document.getElementById('category').value = '';
      document.getElementById('prepTime').value = '';
      document.getElementById('cookTime').value = '';
      document.getElementById('serves').value = '';
      document.getElementById('makes').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('source').value = '';
      document.getElementById('sourceUrl').value = '';
      document.getElementById('ingredientsList').innerHTML = '';
      document.getElementById('stepsList').innerHTML = '';
      for (let i = 0; i < 5; i++) addIngredient();
      for (let i = 0; i < 4; i++) addStep();
      hideStatus('importStatus');
      hideStatus('submitStatus');
    }
    
    async function importRecipeWithAI() {
      const url = document.getElementById('importUrl').value.trim();
      if (!url) {
        showStatus('importStatus', 'Please enter a URL', 'error');
        return;
      }
      
      const btn = document.getElementById('importBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-pulse">‚ú® Fetching page...</span>';
      showStatus('importStatus', 'Fetching recipe page...', 'loading ai');
      
      try {
        const response = await fetch(CORS_PROXY + encodeURIComponent(url));
        if (!response.ok) throw new Error('Failed to fetch URL');
        const html = await response.text();
        
        btn.innerHTML = '<span class="loading-pulse">‚ú® AI is reading recipe...</span>';
        showStatus('importStatus', 'AI is extracting and formatting the recipe...', 'loading ai');
        
        const recipe = await parseRecipeWithClaude(html, url);
        
        if (!recipe.title) {
          throw new Error('Could not extract recipe from this page');
        }
        
        populateForm(recipe);
        showStatus('importStatus', '‚ú® Recipe imported! Review and edit below.', 'success');
        
      } catch (err) {
        console.error(err);
        showStatus('importStatus', 'Import failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>‚ú® Import with AI</span>';
      }
    }
    
    async function parseRecipeWithClaude(html, sourceUrl) {
      const cleanHtml = html
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
        .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
        .replace(/<nav\b[^<]*(?:(?!<\/nav>)<[^<]*)*<\/nav>/gi, '')
        .replace(/<footer\b[^<]*(?:(?!<\/footer>)<[^<]*)*<\/footer>/gi, '')
        .replace(/<header\b[^<]*(?:(?!<\/header>)<[^<]*)*<\/header>/gi, '')
        .replace(/\s+/g, ' ')
        .substring(0, 50000);
      
      const systemPrompt = 'You are a recipe extraction assistant. Extract recipe information from HTML and return it as JSON.\n\nReturn ONLY valid JSON with this exact structure (no markdown, no explanation):\n{\n  "title": "Recipe Title",\n  "tagline": "A short, punchy, appetizing description (max 10 words, be creative!)",\n  "category": "one of: soups-stews, pasta, chicken, beef, pork, seafood, breakfast, sides, baking-dessert, basics",\n  "prepTime": "20 min",\n  "cookTime": "45 min",\n  "serves": "4-6",\n  "makes": "only if applicable, like 24 cookies, otherwise null",\n  "ingredients": ["1 cup flour", "2 eggs", "..."],\n  "steps": ["Preheat oven to 375¬∞F.", "Mix dry ingredients.", "..."],\n  "notes": "Any helpful tips, substitutions, or notes from the recipe. Can be null.",\n  "source": "Website name or author"\n}\n\nGuidelines:\n- tagline should be catchy and appetizing, NOT the full description. Examples: "Crispy, cheesy, weeknight-easy", "Fall-apart tender, worth the wait", "The only chocolate chip cookie recipe you need"\n- Clean up ingredient formatting: "1 lb chicken breast, boneless skinless" ‚Üí "1 lb boneless skinless chicken breast"\n- Steps should be clear and actionable, not too long\n- Pick the most appropriate category\n- If times are not specified, estimate based on the recipe\n- Extract any useful notes/tips the author mentions';

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4096,
          messages: [{
            role: 'user',
            content: 'Extract the recipe from this page. Source URL: ' + sourceUrl + '\n\nHTML:\n' + cleanHtml
          }],
          system: systemPrompt
        })
      });
      
      if (!response.ok) {
        const err = await response.text();
        console.error('Claude API error:', err);
        throw new Error('AI service error');
      }
      
      const data = await response.json();
      const content = data.content[0].text;
      
      try {
        let jsonStr = content;
        const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (jsonMatch) {
          jsonStr = jsonMatch[1];
        }
        
        const recipe = JSON.parse(jsonStr.trim());
        recipe.sourceUrl = sourceUrl;
        return recipe;
      } catch (e) {
        console.error('Failed to parse Claude response:', content);
        throw new Error('Failed to parse recipe data');
      }
    }
    
    function populateForm(recipe) {
      document.getElementById('title').value = recipe.title || '';
      document.getElementById('tagline').value = recipe.tagline || '';
      document.getElementById('category').value = recipe.category || '';
      document.getElementById('prepTime').value = recipe.prepTime || '';
      document.getElementById('cookTime').value = recipe.cookTime || '';
      document.getElementById('serves').value = recipe.serves || '';
      document.getElementById('makes').value = recipe.makes || '';
      document.getElementById('notes').value = recipe.notes || '';
      document.getElementById('source').value = recipe.source || '';
      document.getElementById('sourceUrl').value = recipe.sourceUrl || '';
      
      document.getElementById('ingredientsList').innerHTML = '';
      if (recipe.ingredients && recipe.ingredients.length) {
        recipe.ingredients.forEach(function(ing) { addIngredient(ing); });
      } else {
        for (let i = 0; i < 5; i++) addIngredient();
      }
      
      document.getElementById('stepsList').innerHTML = '';
      if (recipe.steps && recipe.steps.length) {
        recipe.steps.forEach(function(step) { addStep(step); });
      } else {
        for (let i = 0; i < 4; i++) addStep();
      }
    }
    
    async function submitRecipe() {
      const title = document.getElementById('title').value.trim();
      const tagline = document.getElementById('tagline').value.trim();
      const category = document.getElementById('category').value;
      
      if (!title) { showStatus('submitStatus', 'Please enter a recipe title', 'error'); return; }
      if (!tagline) { showStatus('submitStatus', 'Please enter a tagline', 'error'); return; }
      if (!category) { showStatus('submitStatus', 'Please select a category', 'error'); return; }
      
      const ingredients = Array.from(document.querySelectorAll('#ingredientsList input'))
        .map(function(input) { return input.value.trim(); })
        .filter(function(v) { return v; });
      
      if (ingredients.length === 0) { showStatus('submitStatus', 'Please add at least one ingredient', 'error'); return; }
      
      const steps = Array.from(document.querySelectorAll('#stepsList input'))
        .map(function(input) { return input.value.trim(); })
        .filter(function(v) { return v; });
      
      if (steps.length === 0) { showStatus('submitStatus', 'Please add at least one step', 'error'); return; }
      
      const recipeData = {
        user_id: currentUser.id,
        user_email: currentUser.email,
        status: 'pending',
        title: title,
        tagline: tagline,
        category: category,
        prep_time: document.getElementById('prepTime').value.trim() || null,
        cook_time: document.getElementById('cookTime').value.trim() || null,
        serves: document.getElementById('serves').value.trim() || null,
        makes: document.getElementById('makes').value.trim() || null,
        ingredients: ingredients,
        steps: steps,
        notes: document.getElementById('notes').value.trim() || null,
        source: document.getElementById('source').value.trim() || null,
        source_url: document.getElementById('sourceUrl').value.trim() || null
      };
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>Submitting...</span>';
      showStatus('submitStatus', 'Saving recipe...', 'loading');
      
      try {
        const { data, error } = await supabase
          .from('recipes')
          .insert([recipeData])
          .select();
        
        if (error) throw error;
        
        showSuccess();
        clearForm();
        
      } catch (err) {
        console.error('Submit error:', err);
        showStatus('submitStatus', 'Failed to submit: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Submit Recipe</span>';
      }
    }
    
    async function loadMyRecipes() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('recipes')
          .select('id, title, status, created_at')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('recipesList');
        
        if (!data || data.length === 0) {
          container.innerHTML = '<p class="no-recipes">No recipes submitted yet.</p>';
          return;
        }
        
        container.innerHTML = data.map(function(recipe) {
          return '<div class="recipe-item"><span class="recipe-title">' + escapeHtml(recipe.title) + '</span><span class="recipe-status ' + recipe.status + '">' + recipe.status + '</span></div>';
        }).join('');
        
      } catch (err) {
        console.error('Load recipes error:', err);
        document.getElementById('recipesList').innerHTML = '<p class="no-recipes">Failed to load recipes.</p>';
      }
    }
    
    function showStatus(id, message, type) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.className = 'status show ' + type;
    }
    
    function hideStatus(id) {
      const el = document.getElementById(id);
      el.className = 'status';
    }
    
    function resetAll() {
      clearForm();
      showForm();
      loadMyRecipes();
    }
    
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
